<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S高・S安 履歴</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">
<meta name="apple-mobile-web-app-title" content="S高履歴">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

  body {
    margin: 0;
    padding: 10px;
    font-family: 'Roboto', Helvetica, Arial, sans-serif;
    background-color: #f1f3f4;
  }

  /* ▼▼▼ タイトルエリア ▼▼▼ */
  .title-area {
    display: flex;
    align-items: center;
    margin: 10px 0 15px 5px;
  }
  .title-area h3 {
    margin: 0;
    color: #202124;
    font-size: 18px;
    line-height: 1;
  }
  .title-img-left, .title-img-right {
    width: 24px;
    height: 24px;
    margin: 0 8px;
    object-fit: contain;
  }
  .title-img-left { margin-left: 0; }

  a {
    color: inherit;
    text-decoration: underline;
    text-decoration-color: rgba(0,0,0,0.3);
  }

  /* ▼▼▼ 凡例エリア ▼▼▼ */
  .legend-area {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
    padding: 10px 12px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(60,64,67,0.1);
    font-size: 11px;
    color: #444;
    border: 1px solid #dadce0;
  }
  .legend-item {
    display: flex;
    align-items: center;
    width: 48%; 
    box-sizing: border-box;
  }
  .legend-item.full-width {
    width: 100%;
    margin-top: 4px;
    border-top: 1px dashed #eee;
    padding-top: 6px;
  }
  .legend-icon-img, .bbs-icon, .kabutan-icon, .x-icon {
    width: 16px;
    height: 16px;
    object-fit: cover;
    border-radius: 3px;
    margin-right: 6px;
    vertical-align: middle;
  }
  .x-icon { display: block; margin: 4px auto 0; }
  .bbs-icon { margin-left: 5px; }
  .kabutan-icon { margin-right: 5px; }

  /* ▼▼▼ 市場切り替えボタン ▼▼▼ */
  .market-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0 10px 0;
  }
  .market-btn {
    flex: 1;
    max-width: 100px;
    padding: 8px 0;
    text-align: center;
    background-color: #fff;
    border: 1px solid #999;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    color: #555;
    cursor: pointer;
    transition: all 0.2s;
  }
  .market-btn.active {
    background-color: #333;
    color: #fff;
    border-color: #333;
  }

  /* ▼▼▼ 月選択タブ ▼▼▼ */
  .tabs {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    margin-bottom: 10px;
    padding-bottom: 5px;
    gap: 8px;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab-button {
    background-color: #fff;
    border: 1px solid #dadce0;
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 13px;
    cursor: pointer;
    color: #5f6368;
    font-weight: 500;
  }
  .tab-button.active {
    background-color: #e91e63;
    color: white;
    border-color: #e91e63;
  }

  /* ▼▼▼ テーブル ▼▼▼ */
  .stock-table-container {
    background: white;
    width: 100%;
    overflow-x: hidden;
    border: 1px solid #dadce0;
    box-shadow: 0 1px 2px rgba(60,64,67,0.3);
    border-radius: 4px;
    min-height: 200px; /* ローディング領域確保 */
  }
  
  table.stock-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: fixed;
  }
  table.stock-table th {
    background-color: #e91e63;
    color: white;
    padding: 8px 2px;
    font-weight: bold;
    text-align: center;
    border: 1px solid #c2185b;
    white-space: nowrap;
  }
  table.stock-table td {
    padding: 8px 2px;
    border: 1px solid #e0e0e0;
    color: #333;
    vertical-align: middle;
    text-align: center;
    word-wrap: break-word;
  }
  /* 銘柄名 */
  table.stock-table td:nth-child(3) {
    text-align: left;
    white-space: normal;
    padding-left: 5px;
  }
  table.stock-table tr:nth-child(even) { background-color: #fff0f5; }
  tr.date-changed td { border-top: 2px solid #888 !important; }
  .text-red { color: #d32f2f !important; font-weight: bold; }
  .text-blue { color: #1976d2 !important; font-weight: bold; }

  /* スマホ表示調整 */
  @media screen and (max-width: 600px) {
    table.stock-table { font-size: 11px; }
    table.stock-table th:nth-child(1), table.stock-table td:nth-child(1) { width: 15%; }
    table.stock-table th:nth-child(2), table.stock-table td:nth-child(2) { width: 14%; }
    table.stock-table th:nth-child(3), table.stock-table td:nth-child(3) { width: auto; }
    table.stock-table th:nth-child(4), table.stock-table td:nth-child(4) { width: 16%; }
    table.stock-table th:nth-child(5), table.stock-table td:nth-child(5) { width: 16%; }
  }

  /* ローディング表示 */
  #loading {
    text-align: center;
    padding: 40px 20px;
    color: #5f6368;
    font-size: 14px;
    line-height: 1.6;
  }
  .error-msg {
    color: #d32f2f;
    font-weight: bold;
    background: #ffebee;
    padding: 10px;
    border-radius: 4px;
    display: inline-block;
  }
</style>
</head>
<body>

<div class="title-area">
  <img src="sd.jpg" class="title-img-left">
  <h3>ストップ高・ストップ安 履歴</h3>
  <img src="ss.jpg" class="title-img-right">
</div>

<div class="legend-area">
  <div class="legend-item"><img src="bbs.jpg" class="legend-icon-img"> 掲示板へ</div>
  <div class="legend-item"><img src="kabu.jpg" class="legend-icon-img"> 株探ページへ</div>
  <div class="legend-item full-width"><img src="x.jpg" class="legend-icon-img"> X検索 <span class="legend-note">※最新タブ「コード 株」で検索されます。スマホは切替必要</span></div>
</div>

<div class="market-tabs">
    <div class="market-btn active" id="btn-all" onclick="switchMarket('all')">全市場</div>
    <div class="market-btn" id="btn-std" onclick="switchMarket('std')">スタンダード</div>
    <div class="market-btn" id="btn-grw" onclick="switchMarket('grw')">グロース</div>
</div>

<div class="tabs" id="monthTabs"></div>

<div class="stock-table-container">
  <div id="loading">データを読み込んでいます...</div>
  <table class="stock-table" id="stockTable" style="display:none;">
    <thead id="tableHead">
        <tr><th>日付</th><th>コード</th><th>銘柄名</th><th>株価</th><th>前日比</th></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  // ▼▼▼ 設定エリア ▼▼▼
  const SHEET_ID = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; 
  const SHEET_GIDS = {
      all: "0",          // data
      std: "1953765914", // data_std
      grw: "1943516156"  // data_grw
  };
  // ▲▲▲▲▲▲▲▲▲▲▲

  let allData = [];

  window.onload = function() { switchMarket('all'); };

  function switchMarket(type) {
      document.querySelectorAll('.market-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${type}`).classList.add('active');

      document.getElementById('stockTable').style.display = 'none';
      const loadingEl = document.getElementById('loading');
      loadingEl.style.display = 'block';
      loadingEl.textContent = "データを読み込んでいます...";
      
      loadSheetData(type);
  }

  async function loadSheetData(type) {
    const gid = SHEET_GIDS[type];
    // ★重要★ exportではなく gviz/tq を使用 (CORS対策)
    // t=Date.now() はキャッシュ対策
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;

    try {
        const response = await fetch(url);
        
        if (!response.ok) {
           throw new Error(`通信エラー: ${response.status} ${response.statusText}`);
        }
        
        const text = await response.text();
        
        // Googleのログイン画面が返ってきていないかチェック
        if (text.includes("<!DOCTYPE html>") || text.includes("google-site-verification")) {
             throw new Error("データではなくHTMLが返されました。「Webに公開」が設定されていない可能性があります。");
        }

        parseAndRender(text);

    } catch (error) {
        console.error('Error:', error);
        const loadingEl = document.getElementById('loading');
        loadingEl.innerHTML = `
            <div class="error-msg">データの読み込みに失敗しました</div>
            <br><br>
            <div style="text-align:left; display:inline-block; font-size:12px;">
            <b>考えられる原因：</b><br>
            1. スプレッドシートの「ファイル > 共有 > <b>Webに公開</b>」がされていない。<br>
            2. インターネット接続が不安定。<br>
            <br>
            エラー詳細: ${error.message}
            </div>
        `;
    }
  }

  function parseAndRender(csvText) {
      const lines = csvText.trim().split('\n');
      if (lines.length < 2) {
           document.getElementById('loading').textContent = "データが見つかりませんでした (空のファイル)";
           return;
      }

      const dataRows = [];
      // gvizのCSVはデータが "" で囲まれていることが多いので処理
      for(let i = 1; i < lines.length; i++) {
          // 簡易CSVパース: カンマで分割し、前後の"を削除
          const row = lines[i].split(',').map(cell => cell.replace(/^"|"$/g, ''));
          if(row.length > 1) dataRows.push(row);
      }

      // 日付降順ソート
      dataRows.sort((a, b) => {
          if (a[0] < b[0]) return 1;
          if (a[0] > b[0]) return -1;
          return 0;
      });

      allData = dataRows;
      createMonthTabs(allData);
      drawRows(allData);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('stockTable').style.display = 'table';
  }

  function createMonthTabs(rows) {
    const tabsContainer = document.getElementById('monthTabs');
    tabsContainer.innerHTML = ""; 

    const months = new Set();
    rows.forEach(row => {
      // 2025/12/25 のような形式を想定
      const dateStr = row[0];
      const match = dateStr.match(/^(\d{4}\/\d{1,2})/); 
      if (match) months.add(match[1]);
    });

    // すべてボタン
    const allButton = document.createElement('button');
    allButton.className = 'tab-button active';
    allButton.textContent = 'すべて';
    allButton.onclick = () => {
      updateActiveTab(allButton);
      drawRows(allData);
    };
    tabsContainer.appendChild(allButton);

    // 月ごとのボタン
    months.forEach(month => {
      const btn = document.createElement('button');
      btn.className = 'tab-button';
      btn.textContent = month; 
      btn.onclick = () => {
        updateActiveTab(btn);
        const filtered = allData.filter(row => row[0].startsWith(month));
        drawRows(filtered);
      };
      tabsContainer.appendChild(btn);
    });
  }

  function updateActiveTab(clickedBtn) {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    clickedBtn.classList.add('active');
  }

  function drawRows(rows) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (rows.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5">該当するデータがありません</td></tr>';
      return;
    }

    rows.forEach((row, index) => { 
      let tr = document.createElement('tr');
      
      // 日付の境界線
      if (index > 0) {
        if (row[0] !== rows[index - 1][0]) {
           tr.classList.add("date-changed");
        }
      }

      // 列定義: [0]日付 [1]コード [2]銘柄名 ... [5]前日比 [6]株価
      const dateStr = row[0];
      const stockCode = row[1];
      const stockName = row[2];
      const changeVal = row[5] || "-";
      const priceVal  = row[6] || "-";

      // 1. 日付
      let tdDate = document.createElement('td');
      let shortDate = dateStr.replace(/^\d{4}\//, '');
      tdDate.innerHTML = `<div>${shortDate}</div>`;
      
      let xLink = document.createElement('a');
      const query = encodeURIComponent(stockCode + " " + stockName + " 株");
      xLink.href = `https://x.com/search?q=${query}&src=typed_query&f=live`;
      xLink.target = "_blank";
      xLink.rel = "noopener noreferrer";
      let xIcon = document.createElement('img');
      xIcon.src = "x.jpg"; 
      xIcon.className = "x-icon"; 
      xLink.appendChild(xIcon);
      tdDate.appendChild(xLink);
      tr.appendChild(tdDate);

      // 2. コード
      let tdCode = document.createElement('td');
      tdCode.innerHTML = `<a href="https://finance.yahoo.co.jp/quote/${stockCode}.T/bbs" target="_blank"><img src="bbs.jpg" class="bbs-icon">${stockCode}</a>`;
      tr.appendChild(tdCode);

      // 3. 銘柄名
      let tdName = document.createElement('td');
      tdName.innerHTML = `<a href="https://kabutan.jp/stock/?code=${stockCode}" target="_blank"><img src="kabu.jpg" class="kabutan-icon">${stockName}</a>`;
      tr.appendChild(tdName);

      // 4. 株価
      let tdPrice = document.createElement('td');
      tdPrice.textContent = priceVal;
      tdPrice.style.textAlign = "right";
      tr.appendChild(tdPrice);

      // 5. 前日比
      let tdChange = document.createElement('td');
      tdChange.textContent = changeVal;
      tdChange.style.textAlign = "right";
      if (changeVal.includes('+') || (parseFloat(changeVal) > 0)) tdChange.className = "text-red";
      else if (changeVal.includes('-') || (parseFloat(changeVal) < 0)) tdChange.className = "text-blue";
      tr.appendChild(tdChange);

      tableBody.appendChild(tr);
    });
  }
</script>

</body>
</html>
