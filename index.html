<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sé«˜ãƒ»æ´»æ³éŠ˜æŸ„ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
<link rel="icon" href="icon.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  body { margin: 0; padding: 10px; font-family: 'Roboto', sans-serif; background: #f1f3f4; color: #333; }
  a { text-decoration: none; color: inherit; }
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .app-header { display: flex; align-items: center; margin-bottom: 15px; }
  .app-title { font-size: 18px; font-weight: bold; margin: 0 10px; }
  .icon-img { width: 24px; height: 24px; object-fit: contain; }

  /* åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
  .main-nav { display: flex; gap: 8px; margin-bottom: 12px; }
  .nav-item {
    flex: 1; padding: 12px 0; border-radius: 8px; border: none;
    font-size: 14px; font-weight: bold; color: #666; background: #e0e0e0;
    cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 3px rgba(0,0,0,0.1);
  }
  .nav-item.shigh.active { background: #e91e63; color: white; transform: translateY(1px); }
  .nav-item.active-stock.active { background: #ff9800; color: white; transform: translateY(1px); }

  /* ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
  .sub-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
  .sub-nav::-webkit-scrollbar { display: none; }
  .pill-btn {
    padding: 6px 14px; background: white; border: 1px solid #ccc; border-radius: 20px;
    font-size: 12px; white-space: nowrap; cursor: pointer; color: #555;
  }
  .pill-btn.active { background: #333; color: white; border-color: #333; font-weight: bold; }

  /* å‡¡ä¾‹ */
  .links-area { background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 11px; display: flex; flex-wrap: wrap; gap: 12px; border: 1px solid #ddd; }
  .link-item { display: flex; align-items: center; }
  .small-icon { width: 16px; height: 16px; margin-right: 4px; border-radius: 3px; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-wrap { background: white; border-radius: 4px; border: 1px solid #ddd; overflow-x: hidden; min-height: 200px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
  th { background: #f5f5f5; color: #333; padding: 10px 4px; border-bottom: 2px solid #ddd; font-weight: bold; white-space: nowrap; }
  body.mode-shigh th { background: #e91e63; color: white; border-color: #c2185b; }
  body.mode-active th { background: #ff9800; color: white; border-color: #f57c00; }
  td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; word-wrap: break-word; }
  
  .text-red { color: #d32f2f; font-weight: bold; }
  .text-blue { color: #1976d2; font-weight: bold; }
  .date-sep td { border-top: 2px solid #999 !important; }
  .hidden { display: none !important; }

  /* ãƒ‡ãƒãƒƒã‚°ç”¨è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #debug-log {
    margin-top: 20px; padding: 10px; background: #333; color: #0f0; 
    font-family: monospace; font-size: 10px; border-radius: 4px; display: none;
    white-space: pre-wrap; word-break: break-all;
  }
</style>
</head>
<body class="mode-shigh">

<div class="app-header">
  <img src="sd.jpg" class="icon-img" onerror="this.style.display='none'">
  <div class="app-title">æ ªå¼ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</div>
  <img src="ss.jpg" class="icon-img" onerror="this.style.display='none'">
</div>

<div class="main-nav">
  <button class="nav-item shigh active" onclick="switchMainMode('shigh')">ğŸ“ˆ Sé«˜å±¥æ­´</button>
  <button class="nav-item active-stock" onclick="switchMainMode('active')">ğŸ”¥ æ´»æ³éŠ˜æŸ„</button>
</div>

<div class="links-area">
  <div class="link-item"><img src="bbs.jpg" class="small-icon" onerror="this.style.display='none'">æ²ç¤ºæ¿</div>
  <div class="link-item"><img src="kabu.jpg" class="small-icon" onerror="this.style.display='none'">æ ªæ¢</div>
  <div class="link-item" style="width:100%; border-top:1px dashed #eee; padding-top:4px; margin-top:-4px;">
    <img src="x.jpg" class="small-icon" onerror="this.style.display='none'">X(Twitter)æ¤œç´¢
  </div>
</div>

<div id="sub-active" class="sub-nav hidden">
  <button class="pill-btn active" onclick="loadActiveData('all', this)">å…¨å¸‚å ´</button>
  <button class="pill-btn" onclick="loadActiveData('std', this)">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</button>
  <button class="pill-btn" onclick="loadActiveData('grw', this)">ã‚°ãƒ­ãƒ¼ã‚¹</button>
</div>

<div id="sub-shigh" class="sub-nav"></div>

<div class="table-wrap">
  <div id="loading" style="padding:40px; text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  <table id="dataTable" style="display:none;">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="debug-log"></div>

<script>
  // â–¼ IDè¨­å®šï¼ˆç›´å‰ã®ã‚„ã‚Šå–ã‚Šã§ç¢ºèªã—ãŸæ­£ã—ã„IDï¼‰
  const ID_SHIGH  = "1GomxLhDw7ukSwr4PuhYrhCdncvIx2Eb5uznl1bzgeLk"; 
  const ID_ACTIVE = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; 

  const GIDS = {
    shigh: "0",
    active_all: "0",
    active_std: "1953765914",
    active_grw: "1943516156"
  };

  let currentMode = 'shigh'; 
  let cachedSHighData = [];

  window.onload = () => { switchMainMode('shigh'); };

  function log(msg) {
    const el = document.getElementById('debug-log');
    el.style.display = 'block';
    el.textContent += msg + "\n";
    console.log(msg);
  }

  function switchMainMode(mode) {
    currentMode = mode;
    document.body.className = `mode-${mode}`;

    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.querySelector(`.nav-item.${mode === 'shigh' ? 'shigh' : 'active-stock'}`).classList.add('active');

    document.getElementById('sub-active').classList.toggle('hidden', mode !== 'active');
    document.getElementById('sub-shigh').classList.toggle('hidden', mode !== 'shigh');

    if(mode === 'shigh') {
      if(cachedSHighData.length > 0) {
        renderSHighTabs(cachedSHighData);
        filterSHighByMonth('all');
      } else {
        loadSHighData();
      }
    } else {
      loadActiveData('all');
    }
  }

  async function fetchCSV(sheetId, gid) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('dataTable').style.display = 'none';
    
    // t=Date.now() ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;
    
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + res.status);
      const text = await res.text();
      
      if(text.includes("<!DOCTYPE html>")) {
         throw new Error("ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªããƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚Webå…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
      return parseCSV(text);
    } catch(e) {
      document.getElementById('loading').innerHTML = `<span style="color:red; font-weight:bold;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span><br><br>è©³ç´°: ${e.message}`;
      log(`Fetch Error [${sheetId}]: ${e.message}`);
      return null;
    }
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const data = [];
    for(let i=1; i<lines.length; i++) {
      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆé™¤å»ã€å††ãƒãƒ¼ã‚¯é™¤å»
      const row = lines[i].split(',').map(cell => 
        cell.replace(/^"|"$/g, '').replace(/[å††Â¥,]/g, '')
      );
      // ç©ºè¡Œãƒã‚§ãƒƒã‚¯
      if(row.length > 1) {
          if(row[1]) row[1] = row[1].replace('.0', ''); // ã‚³ãƒ¼ãƒ‰ã®.0é™¤å»
          data.push(row);
      }
    }
    // æ—¥ä»˜é™é †ã‚½ãƒ¼ãƒˆ
    return data.sort((a, b) => a[0] < b[0] ? 1 : -1);
  }

  // --- Sé«˜å±¥æ­´ãƒ­ã‚¸ãƒƒã‚¯ ---
  async function loadSHighData() {
    const data = await fetchCSV(ID_SHIGH, GIDS.shigh);
    if(!data) return;
    
    // ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦åˆ—æ•°ã‚’ãƒ­ã‚°å‡ºåŠ›
    log(`Sé«˜ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${data.length}ä»¶`);
    if(data.length > 0) log(`Sé«˜åˆ—æ•°: ${data[0].length} / å…ˆé ­è¡Œ: ${JSON.stringify(data[0])}`);

    cachedSHighData = data;
    renderSHighTabs(data);
    filterSHighByMonth('all');
  }

  function renderSHighTabs(rows) {
    const container = document.getElementById('sub-shigh');
    container.innerHTML = "";
    const months = new Set();
    rows.forEach(r => {
      const m = r[0].match(/^(\d{4}\/\d{1,2})/);
      if(m) months.add(m[1]);
    });
    createPillBtn(container, 'ã™ã¹ã¦', true, () => filterSHighByMonth('all'));
    months.forEach(m => createPillBtn(container, m, false, () => filterSHighByMonth(m)));
  }

  function filterSHighByMonth(month) {
    const filtered = (month === 'all') ? cachedSHighData : cachedSHighData.filter(r => r[0].startsWith(month));
    const thead = document.getElementById('tableHead');
    // Sé«˜ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼
    thead.innerHTML = `<tr><th style="width:16%">æ—¥ä»˜</th><th style="width:10%">çŠ¶æ…‹</th><th style="width:16%">ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„å</th><th style="width:18%">æ ªä¾¡</th><th style="width:18%">å‰æ—¥æ¯”</th></tr>`;
    renderTableBody(filtered, 'shigh');
  }

  // --- æ´»æ³éŠ˜æŸ„ãƒ­ã‚¸ãƒƒã‚¯ ---
  async function loadActiveData(type, btn) {
    if(btn) {
      document.querySelectorAll('#sub-active .pill-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    const data = await fetchCSV(ID_ACTIVE, GIDS[`active_${type}`]);
    if(!data) return;

    log(`æ´»æ³ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ(${type}): ${data.length}ä»¶`);

    const thead = document.getElementById('tableHead');
    // æ´»æ³ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼
    thead.innerHTML = `<tr><th style="width:16%">æ—¥ä»˜</th><th style="width:16%">ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„å</th><th style="width:18%">æ ªä¾¡</th><th style="width:18%">å‰æ—¥æ¯”</th></tr>`;
    renderTableBody(data, 'active');
  }

  function renderTableBody(rows, mode) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dataTable').style.display = 'table';

    if(rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
      return;
    }

    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      if(idx > 0 && row[0] !== rows[idx-1][0]) tr.classList.add('date-sep');
      if(idx % 2 === 0) tr.style.backgroundColor = "#fafafa";

      // â–¼â–¼â–¼ åˆ—ã®å‰²ã‚Šå½“ã¦ï¼ˆã“ã“ãŒé‡è¦ï¼‰ â–¼â–¼â–¼
      let dateVal, statusVal, codeVal, nameVal, priceVal, changeVal;

      try {
        dateVal = row[0].replace(/^\d{4}\//, ''); // æ—¥ä»˜ã¯å¸¸ã«å…ˆé ­

        if(mode === 'shigh') {
           // Sé«˜ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹é€ ï¼ˆæ¨å®šï¼‰
           // [0]æ—¥ä»˜ [1]çŠ¶æ…‹ [2]ã‚³ãƒ¼ãƒ‰ [3]å ... [5]å‰æ—¥æ¯” [6]æ ªä¾¡ ??
           // â€»ã‚‚ã—åˆ—ãŒè¶³ã‚Šãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿ã‚’å…¥ã‚Œã¦ã„ã¾ã™
           statusVal = row[1] || "-";
           codeVal   = row[2] || "----";
           nameVal   = row[3] || "åç§°ä¸æ˜";
           // å¾Œã‚ã‹ã‚‰å–ã‚‹æ–¹å¼ã«å¤‰æ›´ï¼ˆé–“ã«ä½™è¨ˆãªåˆ—ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«ï¼‰
           priceVal  =
