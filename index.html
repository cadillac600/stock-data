<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>活況銘柄・S高履歴</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  body { margin: 0; padding: 10px; font-family: 'Roboto', sans-serif; background-color: #f1f3f4; }
  
  /* タイトル */
  .title-area { display: flex; align-items: center; margin: 10px 0 15px 5px; }
  .title-area h3 { margin: 0; color: #202124; font-size: 18px; }
  .title-img { width: 24px; height: 24px; margin-right: 8px; object-fit: contain; }

  /* 凡例 */
  .legend-area { background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 11px; color: #444; border: 1px solid #dadce0; }
  .legend-item { display: inline-flex; align-items: center; margin-right: 15px; }
  .legend-icon { width: 16px; height: 16px; margin-right: 5px; border-radius: 3px; }

  /* 市場切り替えボタン */
  .market-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
  .market-btn {
    flex: 1; padding: 10px 0; text-align: center;
    background: #fff; border: 1px solid #999; border-radius: 4px;
    font-weight: bold; font-size: 13px; color: #555; cursor: pointer;
  }
  .market-btn.active { background: #333; color: #fff; border-color: #333; }

  /* 月タブ */
  .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
  .tab-button {
    padding: 6px 16px; background: #fff; border: 1px solid #dadce0; border-radius: 20px;
    font-size: 13px; color: #5f6368; white-space: nowrap; cursor: pointer;
  }
  .tab-button.active { background: #e91e63; color: white; border-color: #e91e63; }

  /* テーブル */
  .table-container { background: white; border-radius: 4px; border: 1px solid #dadce0; overflow-x: hidden; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
  th { background: #e91e63; color: white; padding: 8px 2px; border: 1px solid #c2185b; white-space: nowrap; }
  td { padding: 8px 2px; border: 1px solid #e0e0e0; text-align: center; vertical-align: middle; }
  
  /* 列幅調整（スマホ最適化） */
  th:nth-child(1) { width: 16%; } /* 日付 */
  th:nth-child(2) { width: 14%; } /* コード */
  th:nth-child(3) { width: auto; } /* 銘柄名 */
  th:nth-child(4) { width: 18%; } /* 株価 */
  th:nth-child(5) { width: 18%; } /* 前日比 */

  td:nth-child(3) { text-align: left; padding-left: 5px; } /* 銘柄名は左寄せ */
  td:nth-child(4), td:nth-child(5) { text-align: right; padding-right: 5px; } /* 数字は右寄せ */

  /* 色分け */
  .text-red { color: #d32f2f; font-weight: bold; }
  .text-blue { color: #1976d2; font-weight: bold; }
  .date-changed td { border-top: 2px solid #888 !important; }

  #loading { padding: 40px; text-align: center; color: #666; }
</style>
</head>
<body>

<div class="title-area">
  <img src="sd.jpg" class="title-img" onerror="this.style.display='none'">
  <h3>活況銘柄・履歴</h3>
</div>

<div class="legend-area">
  <div class="legend-item"><img src="bbs.jpg" class="legend-icon" onerror="this.style.display='none'">掲示板</div>
  <div class="legend-item"><img src="kabu.jpg" class="legend-icon" onerror="this.style.display='none'">株探</div>
  <div class="legend-item"><img src="x.jpg" class="legend-icon" onerror="this.style.display='none'">X検索</div>
</div>

<div class="market-tabs">
    <div class="market-btn active" id="btn-all" onclick="switchMarket('all')">全市場</div>
    <div class="market-btn" id="btn-std" onclick="switchMarket('std')">スタンダード</div>
    <div class="market-btn" id="btn-grw" onclick="switchMarket('grw')">グロース</div>
</div>

<div class="tabs" id="monthTabs"></div>

<div class="table-container">
  <div id="loading">データを読み込み中...</div>
  <table id="stockTable" style="display:none;">
    <thead>
      <tr><th>日付</th><th>コード</th><th>銘柄名</th><th>株価</th><th>前日比</th></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  // ▼▼▼ 設定エリア ▼▼▼
  // 活況銘柄のスプレッドシートID
  const SHEET_ID = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; 
  const SHEET_GIDS = {
      all: "0",          // dataシート (全市場)
      std: "1953765914", // data_stdシート (スタンダード)
      grw: "1943516156"  // data_grwシート (グロース)
  };
  // ▲▲▲▲▲▲▲▲▲▲▲

  let allData = [];
  window.onload = function() { switchMarket('all'); };

  function switchMarket(type) {
      document.querySelectorAll('.market-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`btn-${type}`).classList.add('active');
      
      document.getElementById('stockTable').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading').textContent = "読み込み中...";
      
      loadSheetData(type);
  }

  async function loadSheetData(type) {
    const gid = SHEET_GIDS[type];
    // gviz/tq でCSV取得 (キャッシュ回避のため t=Date.now() を付与)
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");
        const text = await response.text();
        
        // Googleログイン画面が返ってきていないかチェック
        if(text.includes("<!DOCTYPE html>")) {
            throw new Error("スプレッドシートがWebに公開されていません");
        }
        
        parseAndRender(text);
    } catch (e) {
        document.getElementById('loading').innerHTML = 
            `読み込み失敗<br><span style="font-size:11px;color:red;">${e.message}</span>`;
    }
  }

  function parseAndRender(csvText) {
      const lines = csvText.trim().split('\n');
      const dataRows = [];

      // 1行目はヘッダーなので2行目(i=1)から処理
      for(let i = 1; i < lines.length; i++) {
          // カンマ区切りだが、"1,000"のようなデータ内のカンマを無視する簡易パース
          // ここでは単純に split(',') して、値の中の " や ¥, 円 を削除する
          let row = lines[i].split(',').map(cell => 
              cell.replace(/^"|"$/g, '')   // 前後のダブルクォート削除
                  .replace(/[円¥,]/g, '')  // 「円」「¥」「,」を削除して数値化しやすくする
          );
          
          if(row.length > 1) {
              // コードが "9501.0" のようになる場合があるので .0 を消す
              if(row[1]) row[1] = row[1].replace('.0', '');
              dataRows.push(row);
          }
      }

      // 日付降順ソート
      dataRows.sort((a, b) => (a[0] < b[0] ? 1 : -1));
      
      allData = dataRows;
      createMonthTabs(allData);
      drawRows(allData);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('stockTable').style.display = 'table';
  }

  function createMonthTabs(rows) {
      const container = document.getElementById('monthTabs');
      container.innerHTML = "";
      const months = new Set();
      
      rows.forEach(r => {
          const m = r[0].match(/^(\d{4}\/\d{1,2})/);
          if(m) months.add(m[1]);
      });

      // 「すべて」ボタン
      const btnAll = document.createElement('button');
      btnAll.className = 'tab-button active';
      btnAll.textContent = 'すべて';
      btnAll.onclick = () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          btnAll.classList.add('active');
          drawRows(allData);
      };
      container.appendChild(btnAll);

      // 月別ボタン
      months.forEach(m => {
          const btn = document.createElement('button');
          btn.className = 'tab-button';
          btn.textContent = m;
          btn.onclick = () => {
              document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              const filtered = allData.filter(r => r[0].startsWith(m));
              drawRows(filtered);
          };
          container.appendChild(btn);
      });
  }

  function drawRows(rows) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";

      if(rows.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>データなし</td></tr>";
          return;
      }

      rows.forEach((row, idx) => {
          const tr = document.createElement('tr');
          
          // 日付の変わり目に線
          if(idx > 0 && row[0] !== rows[idx-1][0]) {
              tr.classList.add('date-changed');
          }

          // データ割り当て (CSV列番号: 0:日付, 1:コード, 2:名, 3:回数, 4:比%, 5:比, 6:株価)
          // ※先ほどのパースでカンマなどを消しているので数値計算が可能
          const dateStr = row[0].replace(/^\d{4}\//, ''); // 年を削除して短く
          const code    = row[1];
          const name    = row[2];
          const price   = row[6]; // 株価列
          const change  = row[5]; // 前日比列

          // 1. 日付 + Xリンク
          const tdDate = document.createElement('td');
          tdDate.innerHTML = `
            <div>${dateStr}</div>
            <a href="https://x.com/search?q=${code} ${name} 株&src=typed_query&f=live" target="_blank">
              <img src="x.jpg" class="legend-icon" style="margin:2px 0 0 0;" onerror="this.style.display='none'">
            </a>
          `;
          tr.appendChild(tdDate);

          // 2. コード + 掲示板リンク
          const tdCode = document.createElement('td');
          tdCode.innerHTML = `
            <a href="https://finance.yahoo.co.jp/quote/${code}.T/bbs" target="_blank" style="text-decoration:none; color:#333;">
              <span style="font-weight:bold;">${code}</span>
              <img src="bbs.jpg" class="legend-icon" style="vertical-align:text-bottom; margin-left:2px;" onerror="this.style.display='none'">
            </a>
          `;
          tr.appendChild(tdCode);

          // 3. 銘柄名 + 株探リンク
          const tdName = document.createElement('td');
          tdName.innerHTML = `
            <a href="https://kabutan.jp/stock/?code=${code}" target="_blank" style="text-decoration:none; color:#1a0dab;">
              ${name}
              <img src="kabu.jpg" class="legend-icon" style="vertical-align:text-bottom; margin-left:2px;" onerror="this.style.display='none'">
            </a>
          `;
          tr.appendChild(tdName);

          // 4. 株価
          const tdPrice = document.createElement('td');
          tdPrice.textContent = Number(price).toLocaleString(); // 再度カンマ付与
          tr.appendChild(tdPrice);

          // 5. 前日比 (色付け)
          const tdChange = document.createElement('td');
          const numChange = parseFloat(change);
          let displayChange = isNaN(numChange) ? change : numChange.toLocaleString();
          
          if(numChange > 0) {
              tdChange.className = 'text-red';
              displayChange = '+' + displayChange;
          } else if(numChange < 0) {
              tdChange.className = 'text-blue';
          }
          
          tdChange.textContent = displayChange;
          tr.appendChild(tdChange);

          tbody.appendChild(tr);
      });
  }
</script>

</body>
</html>
