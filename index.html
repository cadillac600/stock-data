<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sé«˜ãƒ»æ´»æ³ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
<style>
  body { font-family: sans-serif; background: #f0f0f0; padding: 10px; margin: 0; }
  h3 { margin: 0 0 10px 0; font-size: 16px; }
  
  /* è¨ºæ–­ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #debug-console {
    background: #222; color: #0f0; font-family: monospace; font-size: 11px;
    padding: 10px; border-radius: 4px; margin-bottom: 20px;
    white-space: pre-wrap; word-break: break-all;
    min-height: 100px; border: 2px solid #555;
  }
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ */
  .table-wrap { background: white; padding: 5px; border-radius: 4px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
  th { background: #ddd; padding: 5px; border: 1px solid #ccc; }
  td { padding: 5px; border: 1px solid #ccc; text-align: center; }
  .error { color: red; font-weight: bold; }
  
  button { padding: 10px 20px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
</style>
</head>
<body>

<h3>ğŸ” ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿è¨ºæ–­</h3>

<div id="debug-console">ã“ã“ã«è¨ºæ–­ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>

<button onclick="runDiagnosis()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>

<div class="table-wrap">
  <table id="resultTable">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  // â–¼ IDè¨­å®š
  const ID_SHIGH  = "1GomxLhDw7ukSwr4PuhYrhCdncvIx2Eb5uznl1bzgeLk"; 
  const ID_ACTIVE = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; 

  // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
  function log(msg) {
    const el = document.getElementById('debug-console');
    const time = new Date().toLocaleTimeString();
    el.innerHTML += `[${time}] ${msg}\n`;
    console.log(msg);
  }

  // è¨ºæ–­å®Ÿè¡Œ
  async function runDiagnosis() {
    document.getElementById('debug-console').innerHTML = "--- è¨ºæ–­é–‹å§‹ ---\n";
    document.getElementById('tbody').innerHTML = "";
    
    // 1. æ´»æ³éŠ˜æŸ„ãƒã‚§ãƒƒã‚¯
    log("ã‚¹ãƒ†ãƒƒãƒ—1: æ´»æ³éŠ˜æŸ„(Active)ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ...");
    await testFetch(ID_ACTIVE, "0", "æ´»æ³éŠ˜æŸ„");

    log("\n-----------------------------\n");

    // 2. Sé«˜å±¥æ­´ãƒã‚§ãƒƒã‚¯
    log("ã‚¹ãƒ†ãƒƒãƒ—2: Sé«˜å±¥æ­´(S-High)ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ...");
    await testFetch(ID_SHIGH, "0", "Sé«˜å±¥æ­´");
  }

  async function testFetch(sheetId, gid, name) {
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;
    
    try {
      const res = await fetch(url);
      log(`[${name}] é€šä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status} ${res.statusText}`);
      
      if (!res.ok) {
        log(`[${name}] âŒ ã‚¨ãƒ©ãƒ¼: é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        return;
      }

      const text = await res.text();
      
      // HTMLãŒè¿”ã£ã¦ãã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
      if (text.includes("<!DOCTYPE html>") || text.includes("<html")) {
        log(`[${name}] âŒ ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªããƒ­ã‚°ã‚¤ãƒ³ç”»é¢(HTML)ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚`);
        log(`ğŸ‘‰ åŸå› : ã€Œãƒ•ã‚¡ã‚¤ãƒ« > å…±æœ‰ > Webã«å…¬é–‹ã€ãŒã¾ã ã§ãã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
        return;
      }

      log(`[${name}] âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ (æ–‡å­—æ•°: ${text.length})`);
      
      // ä¸­èº«ã®è§£æ
      const lines = text.trim().split('\n');
      log(`[${name}] è¡Œæ•°: ${lines.length}è¡Œ`);
      
      if (lines.length > 0) {
        // 1è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã®ç¢ºèª
        const header = lines[0];
        log(`[${name}] ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(ç”Ÿãƒ‡ãƒ¼ã‚¿): ${header}`);
        
        // 2è¡Œç›®ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰ã®ç¢ºèª
        if (lines.length > 1) {
            const row1 = lines[1];
            log(`[${name}] ãƒ‡ãƒ¼ã‚¿1è¡Œç›®(ç”Ÿãƒ‡ãƒ¼ã‚¿): ${row1}`);
            
            // ãƒ‘ãƒ¼ã‚¹ã—ã¦ã¿ã‚‹
            const parsed = row1.split(',').map(s => s.replace(/^"|"$/g, ''));
            log(`[${name}] åˆ—æ•°åˆ¤å®š: ${parsed.length}åˆ—`);
            parsed.forEach((col, idx) => {
                log(`  åˆ—[${idx}]: ${col}`);
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã«æç”»ã—ã¦ã¿ã‚‹
            renderSample(lines, name);
        }
      }

    } catch (e) {
      log(`[${name}] âŒ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: ${e.message}`);
    }
  }

  function renderSample(lines, name) {
    const tbody = document.getElementById('tbody');
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 
    const row = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 10;
    td.style.background = "#333";
    td.style.color = "#fff";
    td.textContent = `â–¼ ${name} ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æœ€åˆã®3è¡Œ) â–¼`;
    row.appendChild(td);
    tbody.appendChild(row);

    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆæœ€å¤§3è¡Œï¼‰
    for(let i=0; i<Math.min(lines.length, 4); i++) {
        const tr = document.createElement('tr');
        const cells = lines[i].split(',');
        cells.forEach(c => {
            const td = document.createElement('td');
            td.textContent = c.replace(/^"|"$/g, '');
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
  }

  // è‡ªå‹•å®Ÿè¡Œ
  window.onload = runDiagnosis;
</script>
</body>
</html>
