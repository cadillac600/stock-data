<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sé«˜ãƒ»Så®‰ å±¥æ­´</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="Sé«˜å±¥æ­´">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            padding-top: 60px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã• */
            -webkit-text-size-adjust: 100%;
        }

        /* --- å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #f5f5f5; /* èƒŒæ™¯ã¯ç™½ç³»ã§ã‚·ãƒ³ãƒ—ãƒ«ã« */
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .app-title {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç°¡æ˜“ã‚°ãƒ©ãƒ•ï¼‰ */
        .title-icon {
            margin-right: 8px;
            font-size: 20px;
        }

        /* --- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .table-container {
            width: 100%;
            background-color: white;
            overflow-x: hidden;
        }

        table {
            width: 100%;
            table-layout: fixed; /* åˆ—å¹…å›ºå®š */
            border-collapse: collapse;
            font-size: 11px; /* ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚º */
        }

        th {
            background-color: #e91e63; /* æ¿ƒã„ãƒ”ãƒ³ã‚¯ */
            color: white;
            padding: 10px 2px;
            font-weight: bold;
            text-align: center;
            position: sticky;
            top: 50px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã«å›ºå®š */
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 12px 4px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†ã«å°‘ã—åºƒã‚ã« */
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            line-height: 1.4;
        }

        /* --- æ—¥ä»˜åŒºåˆ‡ã‚Šã®å¤ªç·š --- */
        tr.date-separator {
            border-top: 4px solid #ddd; /* ã‚°ãƒ¬ãƒ¼ã®å¤ªç·š */
        }

        /* --- åˆ—å¹…èª¿æ•´ (iPhone15æœ€é©åŒ–) --- */
        /* åˆ—: [æ—¥ä»˜, çŠ¶æ…‹, ã‚³ãƒ¼ãƒ‰, éŠ˜æŸ„, ç¾åœ¨å€¤, å‰æ—¥æ¯”] */
        th:nth-child(1), td:nth-child(1) { width: 14%; text-align: center; font-size: 10px; color: #666; } /* æ—¥ä»˜ */
        th:nth-child(2), td:nth-child(2) { width: 10%; text-align: center; font-weight: bold; } /* çŠ¶æ…‹ */
        th:nth-child(3), td:nth-child(3) { width: 18%; text-align: center; } /* ã‚³ãƒ¼ãƒ‰(ãƒªãƒ³ã‚¯å«ã‚€) */
        th:nth-child(4), td:nth-child(4) { width: 28%; text-align: left; font-weight: bold; white-space: normal; word-break: break-all;} /* éŠ˜æŸ„ */
        th:nth-child(5), td:nth-child(5) { width: 15%; text-align: right; } /* ç¾åœ¨å€¤ */
        th:nth-child(6), td:nth-child(6) { width: 15%; text-align: right; } /* å‰æ—¥æ¯” */

        /* --- ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³è£…é£¾ --- */
        .link-icon {
            text-decoration: none;
            display: inline-block;
            margin-left: 2px;
            vertical-align: middle;
        }
        /* Yahooã‚¢ã‚¤ã‚³ãƒ³é¢¨ */
        .yahoo-btn {
            background-color: #ff0033; /* Y!ã®èµ¤ */
            color: white;
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 2px;
            font-weight: bold;
            font-family: sans-serif;
        }
        /* ãƒãƒ£ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³é¢¨ */
        .chart-icon {
            color: #e91e63;
            font-size: 14px;
        }

        /* æ–‡å­—è‰² */
        .text-red { color: #cc0000; }
        .text-blue { color: #0000cc; }
        .text-black { color: #000; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="fixed-header">
        <h1 class="app-title">
            <span class="title-icon">ğŸ“ˆ</span>ã‚¹ãƒˆãƒƒãƒ—é«˜ãƒ»ã‚¹ãƒˆãƒƒãƒ—å®‰ å±¥æ­´
        </h1>
    </div>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="table-container">
        <table id="stockTable">
            </table>
    </div>

    <script>
        // â˜…â˜…â˜… GASã®URL (æœ€æ–°ç‰ˆ) â˜…â˜…â˜…
        const gasUrl = "https://script.google.com/macros/s/AKfycbxG748E3HJpiUACWzkbOlekmXFsEhxB-c6zJI_XI50lbzigtm2S8LrkpRS3pUHcm7Kn/exec";

        window.onload = function() {
            fetchData();
        };

        function fetchData() {
            const loading = document.getElementById('loading');
            fetch(gasUrl)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderTable(data);
                })
                .catch(err => {
                    console.error(err);
                    loading.innerHTML = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
                });
        }

        function renderTable(data) {
            const table = document.getElementById('stockTable');
            // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
            let html = `<thead><tr>
                <th>æ—¥ä»˜</th>
                <th>çŠ¶æ…‹</th>
                <th>ã‚³ãƒ¼ãƒ‰</th>
                <th>éŠ˜æŸ„å</th>
                <th>ç¾åœ¨å€¤</th>
                <th>å‰æ—¥æ¯”</th>
            </tr></thead><tbody>`;

            // 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ãï¼‰
            let rows = data.slice(1);

            // 2. ä¸¦ã³æ›¿ãˆ (æ—¥ä»˜é™é † -> Sé«˜ãŒå…ˆ -> Så®‰ãŒå¾Œ)
            rows.sort((a, b) => {
                // æ—¥ä»˜æ¯”è¼ƒ (æ–°ã—ã„æ—¥ä»˜ãŒä¸Š)
                if (a[0] > b[0]) return -1;
                if (a[0] < b[0]) return 1;

                // åŒã˜æ—¥ä»˜ãªã‚‰çŠ¶æ…‹æ¯”è¼ƒ ("Sé«˜" ãŒ "Så®‰" ã‚ˆã‚Šå…ˆã«æ¥ã‚‹ã‚ˆã†ã«)
                // æ–‡å­—åˆ—æ¯”è¼ƒã ã¨ "Så®‰" > "Sé«˜" ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æ˜ç¤ºçš„ã«
                const isHighA = a[1].includes('Sé«˜');
                const isHighB = b[1].includes('Sé«˜');
                if (isHighA && !isHighB) return -1; // AãŒSé«˜ãªã‚‰ä¸Š
                if (!isHighA && isHighB) return 1;  // BãŒSé«˜ãªã‚‰ä¸Š
                return 0; 
            });

            // 3. è¡Œç”Ÿæˆ
            let previousDate = "";

            rows.forEach((row, index) => {
                let dateStrRaw = row[0]; // "2025/12/25(æœ¨)"
                
                // æ—¥ä»˜åŒºåˆ‡ã‚Šç·šã®åˆ¤å®š
                let rowClass = "";
                if (index > 0 && dateStrRaw !== previousDate) {
                    rowClass = "date-separator";
                }
                previousDate = dateStrRaw;

                // æ—¥ä»˜è¡¨ç¤ºã®çŸ­ç¸® (ä¾‹: 12/25æœ¨)
                let dateDisplay = dateStrRaw.replace(/\d{4}\//, '').replace(/[()]/g, '');

                // æ–‡å­—è‰²åˆ¤å®š
                let statusColor = "text-black";
                if(row[1].includes("Sé«˜")) statusColor = "text-red";
                if(row[1].includes("Så®‰")) statusColor = "text-blue";

                let changeColor = "text-black";
                if(String(row[5]).includes('+')) changeColor = "text-red";
                if(String(row[5]).includes('-')) changeColor = "text-blue";

                // ãƒªãƒ³ã‚¯ç”Ÿæˆ
                // Yahooãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ (Y!)
                let yahooLink = `<a href="https://finance.yahoo.co.jp/quote/${row[2]}.T" target="_blank" class="link-icon yahoo-btn">Y!</a>`;
                
                // æ ªæ¢ã‚¢ã‚¤ã‚³ãƒ³ (éŠ˜æŸ„åã®æ¨ªã«ã¤ã‘ã‚‹ã‚°ãƒ©ãƒ•ã£ã½ã„ã‚¢ã‚¤ã‚³ãƒ³)
                let kabutanLink = `<a href="https://kabutan.jp/stock/?code=${row[2]}" target="_blank" class="link-icon chart-icon">ğŸ“ˆ</a>`;

                html += `<tr class="${rowClass}">
                    <td>${dateDisplay}</td>
                    <td class="${statusColor}">${row[1]}</td>
                    <td>
                        <span style="font-weight:bold; font-size:12px;">${row[2]}</span><br>
                        ${yahooLink}
                    </td>
                    <td>
                        ${kabutanLink} ${row[3]}
                    </td>
                    <td>${row[4]}</td>
                    <td class="${changeColor}">${row[5]}</td>
                </tr>`;
            });

            html += `</tbody>`;
            table.innerHTML = html;
        }
    </script>
</body>
</html>
