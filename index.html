<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sé«˜ãƒ»æ´»æ³ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
<link rel="icon" href="icon.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  body { margin: 0; padding: 10px; font-family: 'Roboto', sans-serif; background: #f1f3f4; color: #333; }
  a { text-decoration: none; color: inherit; }
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .app-header { display: flex; align-items: center; margin-bottom: 15px; }
  .app-title { font-size: 18px; font-weight: bold; margin: 0 10px; }
  .icon-img { width: 24px; height: 24px; object-fit: contain; }

  /* åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
  .main-nav { display: flex; gap: 8px; margin-bottom: 12px; }
  .nav-item {
    flex: 1; padding: 12px 0; border-radius: 8px; border: none;
    font-size: 14px; font-weight: bold; color: #666; background: #e0e0e0;
    cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 3px rgba(0,0,0,0.1);
  }
  .nav-item.shigh.active { background: #e91e63; color: white; transform: translateY(1px); }
  .nav-item.active-stock.active { background: #ff9800; color: white; transform: translateY(1px); }

  /* ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
  .sub-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
  .sub-nav::-webkit-scrollbar { display: none; }
  .pill-btn {
    padding: 6px 14px; background: white; border: 1px solid #ccc; border-radius: 20px;
    font-size: 12px; white-space: nowrap; cursor: pointer; color: #555;
  }
  .pill-btn.active { background: #333; color: white; border-color: #333; font-weight: bold; }

  /* å‡¡ä¾‹ */
  .links-area { background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 11px; display: flex; flex-wrap: wrap; gap: 12px; border: 1px solid #ddd; }
  .link-item { display: flex; align-items: center; }
  .small-icon { width: 16px; height: 16px; margin-right: 4px; border-radius: 3px; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-wrap { background: white; border-radius: 4px; border: 1px solid #ddd; overflow-x: hidden; min-height: 200px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
  th { background: #f5f5f5; color: #333; padding: 10px 4px; border-bottom: 2px solid #ddd; font-weight: bold; white-space: nowrap; }
  body.mode-shigh th { background: #e91e63; color: white; border-color: #c2185b; }
  body.mode-active th { background: #ff9800; color: white; border-color: #f57c00; }
  td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; word-wrap: break-word; }
  
  .text-red { color: #d32f2f; font-weight: bold; }
  .text-blue { color: #1976d2; font-weight: bold; }
  .date-sep td { border-top: 2px solid #999 !important; }
  .hidden { display: none !important; }

  #debug-log { margin-top: 20px; padding: 10px; background: #333; color: #fa0; font-size: 10px; border-radius: 4px; display: none; }
</style>
</head>
<body class="mode-shigh">

<div class="app-header">
  <img src="sd.jpg" class="icon-img" onerror="this.style.display='none'">
  <div class="app-title">æ ªå¼ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</div>
  <img src="ss.jpg" class="icon-img" onerror="this.style.display='none'">
</div>

<div class="main-nav">
  <button class="nav-item shigh active" onclick="switchMainMode('shigh')">ğŸ“ˆ Sé«˜å±¥æ­´</button>
  <button class="nav-item active-stock" onclick="switchMainMode('active')">ğŸ”¥ æ´»æ³éŠ˜æŸ„</button>
</div>

<div class="links-area">
  <div class="link-item"><img src="bbs.jpg" class="small-icon" onerror="this.style.display='none'">æ²ç¤ºæ¿</div>
  <div class="link-item"><img src="kabu.jpg" class="small-icon" onerror="this.style.display='none'">æ ªæ¢</div>
  <div class="link-item" style="width:100%; border-top:1px dashed #eee; padding-top:4px; margin-top:-4px;">
    <img src="x.jpg" class="small-icon" onerror="this.style.display='none'">X(Twitter)æ¤œç´¢
  </div>
</div>

<div id="sub-active" class="sub-nav hidden">
  <button class="pill-btn active" onclick="loadActiveData('all', this)">å…¨å¸‚å ´</button>
  <button class="pill-btn" onclick="loadActiveData('std', this)">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</button>
  <button class="pill-btn" onclick="loadActiveData('grw', this)">ã‚°ãƒ­ãƒ¼ã‚¹</button>
</div>

<div id="sub-shigh" class="sub-nav"></div>

<div class="table-wrap">
  <div id="loading" style="padding:40px; text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  <table id="dataTable" style="display:none;">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="debug-log"></div>

<script>
  // â–¼ IDè¨­å®š
  const ID_SHIGH  = "1GomxLhDw7ukSwr4PuhYrhCdncvIx2Eb5uznl1bzgeLk"; 
  const ID_ACTIVE = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; 

  const GIDS = {
    shigh: "0",
    active_all: "0",
    active_std: "1953765914",
    active_grw: "1943516156"
  };

  let currentMode = 'shigh'; 
  let cachedSHighData = [];

  window.onload = () => { switchMainMode('shigh'); };

  function switchMainMode(mode) {
    currentMode = mode;
    document.body.className = `mode-${mode}`;

    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.querySelector(`.nav-item.${mode === 'shigh' ? 'shigh' : 'active-stock'}`).classList.add('active');

    document.getElementById('sub-active').classList.toggle('hidden', mode !== 'active');
    document.getElementById('sub-shigh').classList.toggle('hidden', mode !== 'shigh');

    if(mode === 'shigh') {
      if(cachedSHighData.length > 0) {
        renderSHighTabs(cachedSHighData);
        filterSHighByMonth('all');
      } else {
        loadSHighData();
      }
    } else {
      loadActiveData('all');
    }
  }

  // â˜…å¤‰æ›´ç‚¹ï¼šä¸­ç¶™ã‚µãƒ¼ãƒãƒ¼(allorigins)ã‚’çµŒç”±ã—ã¦å–å¾—ã™ã‚‹é–¢æ•°
  async function fetchCSV(sheetId, gid) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('dataTable').style.display = 'none';
    
    // Googleã®URL
    const googleUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
    
    // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®URL (ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ä¸)
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleUrl)}&t=${Date.now()}`;
    
    try {
      const res = await fetch(proxyUrl);
      if(!res.ok) throw new Error("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + res.status);
      const text = await res.text();
      
      // ä¸­èº«ãƒã‚§ãƒƒã‚¯
      if(text.includes("<!DOCTYPE html>") || text.includes("google-site-verification")) {
         throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆå…¬é–‹è¨­å®šãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
      }
      return parseCSV(text);

    } catch(e) {
      const msg = `èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}`;
      document.getElementById('loading').innerHTML = `<span style="color:red; font-weight:bold;">${msg}</span>`;
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤º
      const dbg = document.getElementById('debug-log');
      dbg.style.display = 'block';
      dbg.textContent = msg + "\n(ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã®å–å¾—ã«å¤±æ•—)";
      return null;
    }
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const data = [];
    for(let i=1; i<lines.length; i++) {
      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const row = lines[i].split(',').map(cell => 
        cell.replace(/^"|"$/g, '').replace(/[å††Â¥,]/g, '')
      );
      if(row.length > 1) {
          if(row[1]) row[1] = row[1].replace('.0', '');
          data.push(row);
      }
    }
    // æ—¥ä»˜é™é †ã‚½ãƒ¼ãƒˆ
    return data.sort((a, b) => a[0] < b[0] ? 1 : -1);
  }

  // --- Sé«˜å±¥æ­´ ---
  async function loadSHighData() {
    const data = await fetchCSV(ID_SHIGH, GIDS.shigh);
    if(!data) return;
    
    cachedSHighData = data;
    renderSHighTabs(data);
    filterSHighByMonth('all');
  }

  function renderSHighTabs(rows) {
    const container = document.getElementById('sub-shigh');
    container.innerHTML = "";
    const months = new Set();
    rows.forEach(r => {
      const m = r[0].match(/^(\d{4}\/\d{1,2})/);
      if(m) months.add(m[1]);
    });
    createPillBtn(container, 'ã™ã¹ã¦', true, () => filterSHighByMonth('all'));
    months.forEach(m => createPillBtn(container, m, false, () => filterSHighByMonth(m)));
  }

  function filterSHighByMonth(month) {
    const filtered = (month === 'all') ? cachedSHighData : cachedSHighData.filter(r => r[0].startsWith(month));
    const thead = document.getElementById('tableHead');
    // Sé«˜ãƒ˜ãƒƒãƒ€ãƒ¼
    thead.innerHTML = `<tr><th style="width:16%">æ—¥ä»˜</th><th style="width:10%">çŠ¶æ…‹</th><th style="width:16%">ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„å</th><th style="width:18%">æ ªä¾¡</th><th style="width:18%">å‰æ—¥æ¯”</th></tr>`;
    renderTableBody(filtered, 'shigh');
  }

  // --- æ´»æ³éŠ˜æŸ„ ---
  async function loadActiveData(type, btn) {
    if(btn) {
      document.querySelectorAll('#sub-active .pill-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    const data = await fetchCSV(ID_ACTIVE, GIDS[`active_${type}`]);
    if(!data) return;

    const thead = document.getElementById('tableHead');
    // æ´»æ³ãƒ˜ãƒƒãƒ€ãƒ¼
    thead.innerHTML = `<tr><th style="width:16%">æ—¥ä»˜</th><th style="width:16%">ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„å</th><th style="width:18%">æ ªä¾¡</th><th style="width:18%">å‰æ—¥æ¯”</th></tr>`;
    renderTableBody(data, 'active');
  }

  // --- æç”»å…±é€š ---
  function renderTableBody(rows, mode) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dataTable').style.display = 'table';

    if(rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
      return;
    }

    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      if(idx > 0 && row[0] !== rows[idx-1][0]) tr.classList.add('date-sep');
      if(idx % 2 === 0) tr.style.backgroundColor = "#fafafa";

      // åˆ—å‰²ã‚Šå½“ã¦
      let dateVal, statusVal, codeVal, nameVal, priceVal, changeVal;

      try {
        dateVal = row[0].replace(/^\d{4}\//, ''); 

        if(mode === 'shigh') {
           // Sé«˜åˆ—æ¨å®š
           statusVal = row[1] || "-";
           codeVal   = row[2] || "----";
           nameVal   = row[3] || "åç§°ä¸æ˜";
           priceVal  = row[row.length - 1] || "0"; 
           changeVal = row[row.length - 2] || "0";
        } else {
           // æ´»æ³åˆ—æ¨å®š
           codeVal   = row[1] || "----";
           nameVal   = row[2] || "åç§°ä¸æ˜";
           priceVal  = row[6] || row[row.length - 1] || "0"; 
           changeVal = row[5] || row[row.length - 2] || "0"; 
        }

        // è¡Œç”Ÿæˆ
        const tdDate = document.createElement('td');
        tdDate.innerHTML = `<div>${dateVal}</div><a href="https://x.com/search?q=${codeVal} ${nameVal} æ ª&src=typed_query&f=live" target="_blank"><img src="x.jpg" class="small-icon" style="margin-top:3px;" onerror="this.style.display='none'"></a>`;
        tr.appendChild(tdDate);

        if(mode === 'shigh') {
          const tdStatus = document.createElement('td');
          tdStatus.textContent = statusVal;
          if(statusVal.includes("Sé«˜")) { tdStatus.style.color = "#d32f2f"; tdStatus.style.fontWeight="bold"; }
          if(statusVal.includes("Så®‰")) { tdStatus.style.color = "#1976d2"; tdStatus.style.fontWeight="bold"; }
          tr.appendChild(tdStatus);
        }

        const tdCode = document.createElement('td');
        tdCode.innerHTML = `<a href="https://finance.yahoo.co.jp/quote/${codeVal}.T/bbs" target="_blank">${codeVal}<img src="bbs.jpg" class="small-icon" style="vertical-align:bottom; margin-left:2px;" onerror="this.style.display='none'"></a>`;
        tr.appendChild(tdCode);

        const tdName = document.createElement('td');
        tdName.style.textAlign = "left";
        tdName.innerHTML = `<a href="https://kabutan.jp/stock/?code=${codeVal}" target="_blank">${nameVal}<img src="kabu.jpg" class="small-icon" style="vertical-align:bottom; margin-left:2px;" onerror="this.style.display='none'"></a>`;
        tr.appendChild(tdName);

        const tdPrice = document.createElement('td');
        tdPrice.style.textAlign = "right";
        tdPrice.textContent = Number(priceVal).toLocaleString();
        tr.appendChild(tdPrice);

        const tdChange = document.createElement('td');
        tdChange.style.textAlign = "right";
        const numChange = parseFloat(changeVal);
        if(!isNaN(numChange)) {
           tdChange.textContent = (numChange > 0 ? "+" : "") + numChange.toLocaleString();
           if(numChange > 0) tdChange.className = "text-red";
           if(numChange < 0) tdChange.className = "text-blue";
        } else {
           tdChange.textContent = changeVal;
        }
        tr.appendChild(tdChange);

      } catch(err) {
        console.log(err);
      }
      tbody.appendChild(tr);
    });
  }

  function createPillBtn(container, text, isActive, onClick) {
    const btn = document.createElement('button');
    btn.className = `pill-btn ${isActive ? 'active' : ''}`;
    btn.textContent = text;
    btn.onclick = () => {
      container.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      onClick();
    };
    container.appendChild(btn);
  }
</script>

</body>
</html>
