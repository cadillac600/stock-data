<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sé«˜ãƒ»æ´»æ³éŠ˜æŸ„ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
<link rel="icon" href="icon.png">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  body { margin: 0; padding: 10px; font-family: 'Roboto', sans-serif; background: #f1f3f4; color: #333; }
  a { text-decoration: none; color: inherit; }
  
  /* --- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ --- */
  .app-header { display: flex; align-items: center; margin-bottom: 15px; }
  .app-title { font-size: 18px; font-weight: bold; margin: 0 10px; }
  .icon-img { width: 24px; height: 24px; object-fit: contain; }

  /* --- ãƒ¡ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆå¤§ï¼‰ --- */
  .main-nav { display: flex; gap: 8px; margin-bottom: 12px; }
  .nav-item {
    flex: 1; padding: 12px 0; border-radius: 8px; border: none;
    font-size: 14px; font-weight: bold; color: #666; background: #e0e0e0;
    cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 3px rgba(0,0,0,0.1);
  }
  /* Sé«˜ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰² */
  .nav-item.shigh.active { background: #e91e63; color: white; transform: translateY(1px); }
  /* æ´»æ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰² */
  .nav-item.active-stock.active { background: #ff9800; color: white; transform: translateY(1px); }

  /* --- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå°ï¼‰ --- */
  .sub-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
  .sub-nav::-webkit-scrollbar { display: none; }
  
  .pill-btn {
    padding: 6px 14px; background: white; border: 1px solid #ccc; border-radius: 20px;
    font-size: 12px; white-space: nowrap; cursor: pointer; color: #555;
  }
  .pill-btn.active { background: #333; color: white; border-color: #333; font-weight: bold; }

  /* --- å‡¡ä¾‹ãƒªãƒ³ã‚¯ --- */
  .links-area { background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 11px; display: flex; flex-wrap: wrap; gap: 12px; border: 1px solid #ddd; }
  .link-item { display: flex; align-items: center; }
  .small-icon { width: 16px; height: 16px; margin-right: 4px; border-radius: 3px; }

  /* --- ãƒ†ãƒ¼ãƒ–ãƒ« --- */
  .table-wrap { background: white; border-radius: 4px; border: 1px solid #ddd; overflow-x: hidden; min-height: 200px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
  
  th { background: #f5f5f5; color: #333; padding: 10px 4px; border-bottom: 2px solid #ddd; font-weight: bold; white-space: nowrap; }
  /* ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼è‰² */
  body.mode-shigh th { background: #e91e63; color: white; border-color: #c2185b; }
  body.mode-active th { background: #ff9800; color: white; border-color: #f57c00; }

  td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; word-wrap: break-word; }
  
  /* åˆ—å¹…èª¿æ•´ */
  .col-date { width: 16%; }
  .col-status { width: 10%; } /* Sé«˜ã®ã¿ */
  .col-code { width: 16%; }
  .col-name { width: auto; text-align: left; }
  .col-price { width: 18%; text-align: right; }
  .col-change { width: 18%; text-align: right; }

  /* è‰²åˆ†ã‘ */
  .text-red { color: #d32f2f; font-weight: bold; }
  .text-blue { color: #1976d2; font-weight: bold; }
  .bg-red-light { background-color: #fff0f5; }
  
  /* æ—¥ä»˜åŒºåˆ‡ã‚Šç·š */
  .date-sep td { border-top: 2px solid #999 !important; }

  /* è¡¨ç¤ºåˆ¶å¾¡ */
  .hidden { display: none !important; }
  #loading { text-align: center; padding: 40px; color: #777; font-size: 13px; }
</style>
</head>
<body class="mode-shigh">

<div class="app-header">
  <img src="sd.jpg" class="icon-img" onerror="this.style.display='none'">
  <div class="app-title">æ ªå¼ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</div>
  <img src="ss.jpg" class="icon-img" onerror="this.style.display='none'">
</div>

<div class="main-nav">
  <button class="nav-item shigh active" onclick="switchMainMode('shigh')">ğŸ“ˆ Sé«˜å±¥æ­´</button>
  <button class="nav-item active-stock" onclick="switchMainMode('active')">ğŸ”¥ æ´»æ³éŠ˜æŸ„</button>
</div>

<div class="links-area">
  <div class="link-item"><img src="bbs.jpg" class="small-icon" onerror="this.style.display='none'">æ²ç¤ºæ¿</div>
  <div class="link-item"><img src="kabu.jpg" class="small-icon" onerror="this.style.display='none'">æ ªæ¢</div>
  <div class="link-item" style="width:100%; border-top:1px dashed #eee; padding-top:4px; margin-top:-4px;">
    <img src="x.jpg" class="small-icon" onerror="this.style.display='none'">X(Twitter)æ¤œç´¢
  </div>
</div>

<div id="sub-active" class="sub-nav hidden">
  <button class="pill-btn active" onclick="loadActiveData('all', this)">å…¨å¸‚å ´</button>
  <button class="pill-btn" onclick="loadActiveData('std', this)">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</button>
  <button class="pill-btn" onclick="loadActiveData('grw', this)">ã‚°ãƒ­ãƒ¼ã‚¹</button>
</div>

<div id="sub-shigh" class="sub-nav"></div>

<div class="table-wrap">
  <div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  <table id="dataTable" style="display:none;">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  // â–¼â–¼â–¼ è¨­å®šï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID â–¼â–¼â–¼
  const ID_SHIGH  = "1GomxLhDw7ukSwr4PuhYrhCdncvIx2Eb5uznl1bzgeLk"; // Sé«˜
  const ID_ACTIVE = "1DiJXYQ8FlHk5_2GEJDmVET8gmHvqwmgTeUXWo5oCmRs"; // æ´»æ³

  const GIDS = {
    shigh: "0",
    active_all: "0",
    active_std: "1953765914",
    active_grw: "1943516156"
  };
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let currentMode = 'shigh'; // 'shigh' or 'active'
  let cachedSHighData = [];  // Sé«˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠã

  // åˆæœŸåŒ–
  window.onload = () => {
    switchMainMode('shigh'); // æœ€åˆã¯Sé«˜ã‚’è¡¨ç¤º
  };

  // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå‡¦ç† ---
  function switchMainMode(mode) {
    currentMode = mode;
    document.body.className = `mode-${mode}`;

    // ãƒœã‚¿ãƒ³è¦‹ãŸç›®
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.querySelector(`.nav-item.${mode === 'shigh' ? 'shigh' : 'active-stock'}`).classList.add('active');

    // ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('sub-active').classList.toggle('hidden', mode !== 'active');
    document.getElementById('sub-shigh').classList.toggle('hidden', mode !== 'shigh');

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
    if(mode === 'shigh') {
      // Sé«˜ã¯ä¸€åº¦èª­ã‚“ã ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ï¼ˆæœˆåˆ‡ã‚Šæ›¿ãˆé«˜é€ŸåŒ–ã®ãŸã‚ï¼‰
      if(cachedSHighData.length > 0) {
        renderSHighTabs(cachedSHighData); // ã‚¿ãƒ–å†æç”»
        filterSHighByMonth('all');        // å…¨è¡¨ç¤º
      } else {
        loadSHighData();
      }
    } else {
      // æ´»æ³ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨å¸‚å ´ã‚’èª­ã¿è¾¼ã¿
      loadActiveData('all');
    }
  }

  // --- CSVå–å¾—ï¼†ãƒ‘ãƒ¼ã‚¹ ---
  async function fetchCSV(sheetId, gid) {
    showLoading(true);
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
      const text = await res.text();
      if(text.includes("<!DOCTYPE")) throw new Error("Webå…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
      
      return parseCSV(text);
    } catch(e) {
      document.getElementById('loading').innerHTML = `<span style="color:red">èª­ã¿è¾¼ã¿å¤±æ•—:<br>${e.message}</span>`;
      return null;
    }
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const data = [];
    // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
    for(let i=1; i<lines.length; i++) {
      // ç°¡æ˜“ãƒ‘ãƒ¼ã‚¹: å‰å¾Œã®"å‰Šé™¤, å††/Â¥/,å‰Šé™¤
      const row = lines[i].split(',').map(cell => 
        cell.replace(/^"|"$/g, '').replace(/[å††Â¥,]/g, '')
      );
      if(row.length > 1) {
          // ã‚³ãƒ¼ãƒ‰ã® ".0" å‰Šé™¤
          if(row[1]) row[1] = row[1].replace('.0', '');
          // æ—¥ä»˜ã®æ­£è¦åŒ– (YYYY/MM/DD)
          if(row[0] && !row[0].includes('/')) { 
             // æ—¥ä»˜å½¢å¼ãŒé•ã†å ´åˆã®ä¿é™ºï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ï¼‰
          }
          data.push(row);
      }
    }
    // æ—¥ä»˜é™é †ã‚½ãƒ¼ãƒˆ
    return data.sort((a, b) => a[0] < b[0] ? 1 : -1);
  }

  function showLoading(isLoading) {
    const table = document.getElementById('dataTable');
    const loading = document.getElementById('loading');
    if(isLoading) {
      table.style.display = 'none';
      loading.style.display = 'block';
    } else {
      table.style.display = 'table';
      loading.style.display = 'none';
    }
  }

  // --- ã€1ã€‘Sé«˜å±¥æ­´ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
  async function loadSHighData() {
    const data = await fetchCSV(ID_SHIGH, GIDS.shigh);
    if(!data) return;

    cachedSHighData = data;
    renderSHighTabs(data);
    filterSHighByMonth('all'); // æœ€åˆã¯ã™ã¹ã¦è¡¨ç¤º
  }

  function renderSHighTabs(rows) {
    const container = document.getElementById('sub-shigh');
    container.innerHTML = "";
    
    // æœˆãƒªã‚¹ãƒˆä½œæˆ
    const months = new Set();
    rows.forEach(r => {
      const m = r[0].match(/^(\d{4}\/\d{1,2})/);
      if(m) months.add(m[1]);
    });

    // ã€Œã™ã¹ã¦ã€ãƒœã‚¿ãƒ³
    createPillBtn(container, 'ã™ã¹ã¦', true, () => filterSHighByMonth('all'));

    // å„æœˆãƒœã‚¿ãƒ³
    months.forEach(m => {
      createPillBtn(container, m, false, () => filterSHighByMonth(m));
    });
  }

  function filterSHighByMonth(month) {
    // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filtered = (month === 'all') 
      ? cachedSHighData 
      : cachedSHighData.filter(r => r[0].startsWith(month));

    // ãƒ˜ãƒƒãƒ€ãƒ¼æç”» (Sé«˜ç”¨)
    const thead = document.getElementById('tableHead');
    thead.innerHTML = `
      <tr>
        <th class="col-date">æ—¥ä»˜</th>
        <th class="col-status">çŠ¶æ…‹</th>
        <th class="col-code">ã‚³ãƒ¼ãƒ‰</th>
        <th class="col-name">éŠ˜æŸ„å</th>
        <th class="col-price">æ ªä¾¡</th>
        <th class="col-change">å‰æ—¥æ¯”</th>
      </tr>
    `;

    renderTableBody(filtered, 'shigh');
  }

  // --- ã€2ã€‘æ´»æ³éŠ˜æŸ„ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
  async function loadActiveData(type, btn) {
    if(btn) {
      document.querySelectorAll('#sub-active .pill-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    const data = await fetchCSV(ID_ACTIVE, GIDS[`active_${type}`]);
    if(!data) return;

    // ãƒ˜ãƒƒãƒ€ãƒ¼æç”» (æ´»æ³ç”¨)
    const thead = document.getElementById('tableHead');
    thead.innerHTML = `
      <tr>
        <th class="col-date">æ—¥ä»˜</th>
        <th class="col-code">ã‚³ãƒ¼ãƒ‰</th>
        <th class="col-name">éŠ˜æŸ„å</th>
        <th class="col-price">æ ªä¾¡</th>
        <th class="col-change">å‰æ—¥æ¯”</th>
      </tr>
    `;

    renderTableBody(data, 'active');
  }

  // --- å…±é€šãƒ†ãƒ¼ãƒ–ãƒ«æç”» ---
  function renderTableBody(rows, mode) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    showLoading(false);

    if(rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
      return;
    }

    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      
      // æ—¥ä»˜ã®åŒºåˆ‡ã‚Šç·š
      if(idx > 0 && row[0] !== rows[idx-1][0]) {
        tr.classList.add('date-sep');
      }
      // å¶æ•°è¡Œã®è‰²
      if(idx % 2 === 0) tr.style.backgroundColor = "#fafafa";

      // åˆ—å®šç¾©ãƒãƒƒãƒ—
      // Sé«˜: [0]æ—¥ä»˜ [1]çŠ¶æ…‹ [2]ã‚³ãƒ¼ãƒ‰ [3]å [4]å›æ•° [5]æ¯”% [6]æ¯” [7]æ ªä¾¡ (æƒ³å®š)
      // æ´»æ³: [0]æ—¥ä»˜ [1]ã‚³ãƒ¼ãƒ‰ [2]å [3]å›æ•° [4]æ¯”% [5]æ¯” [6]æ ªä¾¡ (æƒ³å®š)
      
      let dateVal = row[0].replace(/^\d{4}\//, ''); // å¹´å‰Šé™¤
      let codeVal, nameVal, priceVal, changeVal, statusVal = null;

      if(mode === 'shigh') {
         statusVal = row[1];
         codeVal = row[2];
         nameVal = row[3];
         changeVal = row[6];
         priceVal = row[7];
      } else {
         codeVal = row[1];
         nameVal = row[2];
         changeVal = row[5];
         priceVal = row[6];
      }

      // undefinedå¯¾ç­–
      priceVal = priceVal || "-";
      changeVal = changeVal || "-";

      // --- 1. æ—¥ä»˜ ---
      const tdDate = document.createElement('td');
      tdDate.innerHTML = `
        <div>${dateVal}</div>
        <a href="https://x.com/search?q=${codeVal} ${nameVal} æ ª&src=typed_query&f=live" target="_blank">
          <img src="x.jpg" class="small-icon" style="margin-top:3px;" onerror="this.style.display='none'">
        </a>
      `;
      tr.appendChild(tdDate);

      // --- 2. çŠ¶æ…‹ (Sé«˜ã®ã¿) ---
      if(mode === 'shigh') {
        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusVal;
        if(statusVal && statusVal.includes("Sé«˜")) tdStatus.style.color = "#d32f2f";
        if(statusVal && statusVal.includes("Så®‰")) tdStatus.style.color = "#1976d2";
        tdStatus.style.fontWeight = "bold";
        tdStatus.style.fontSize = "11px";
        tr.appendChild(tdStatus);
      }

      // --- 3. ã‚³ãƒ¼ãƒ‰ ---
      const tdCode = document.createElement('td');
      tdCode.innerHTML = `
        <a href="https://finance.yahoo.co.jp/quote/${codeVal}.T/bbs" target="_blank">
          ${codeVal}<img src="bbs.jpg" class="small-icon" style="vertical-align:bottom; margin-left:2px;" onerror="this.style.display='none'">
        </a>
      `;
      tr.appendChild(tdCode);

      // --- 4. éŠ˜æŸ„å ---
      const tdName = document.createElement('td');
      tdName.className = "col-name";
      tdName.innerHTML = `
        <a href="https://kabutan.jp/stock/?code=${codeVal}" target="_blank">
          ${nameVal}<img src="kabu.jpg" class="small-icon" style="vertical-align:bottom; margin-left:2px;" onerror="this.style.display='none'">
        </a>
      `;
      tr.appendChild(tdName);

      // --- 5. æ ªä¾¡ ---
      const tdPrice = document.createElement('td');
      tdPrice.className = "col-price";
      tdPrice.textContent = Number(priceVal).toLocaleString();
      tr.appendChild(tdPrice);

      // --- 6. å‰æ—¥æ¯” ---
      const tdChange = document.createElement('td');
      tdChange.className = "col-change";
      
      const numChange = parseFloat(changeVal);
      if(!isNaN(numChange)) {
         tdChange.textContent = (numChange > 0 ? "+" : "") + numChange.toLocaleString();
         if(numChange > 0) tdChange.className += " text-red";
         if(numChange < 0) tdChange.className += " text-blue";
      } else {
         tdChange.textContent = changeVal;
      }
      tr.appendChild(tdChange);

      tbody.appendChild(tr);
    });
  }

  // UIãƒ˜ãƒ«ãƒ‘ãƒ¼: ä¸¸ã„ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹
  function createPillBtn(container, text, isActive, onClick) {
    const btn = document.createElement('button');
    btn.className = `pill-btn ${isActive ? 'active' : ''}`;
    btn.textContent = text;
    btn.onclick = () => {
      // è¦ªã‚³ãƒ³ãƒ†ãƒŠå†…ã®å…¨ãƒœã‚¿ãƒ³ã®activeã‚’å¤–ã™
      container.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      onClick();
    };
    container.appendChild(btn);
  }
</script>

</body>
</html>
